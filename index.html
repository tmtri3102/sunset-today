<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sunset Today</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåÖ</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <style>
      body {
        font-family: "Merriweather", sans-serif;
        background-color: #faecdf;
      }
      .factor-card {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #fdf6ef;
      }
      @media (max-width: 390px) {
        body {
          padding-left: 14px;
          padding-right: 14px;
        }
        #main-container > h1 {
          font-size: 1.25rem; /* text-xl */
          line-height: 1.75rem;
        }
        .factor-card {
          padding: 0.875rem;
        }
      }
    </style>
  </head>
  <body
    class="flex items-start min-h-screen px-6 md:px-10 py-10 md:justify-center"
  >
    <div
      id="main-container"
      class="w-full max-w-lg mx-auto text-left rounded-2xl md:p-8 flex flex-col"
    >
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-3 sm:mb-5">
        Ho√†ng h√¥n h√¥m nay th·∫ø n√†o?
      </h1>
      <div class="flex items-center justify-center mb-2">
        <div
          class="relative w-full border-1 border border-[#d9c8b8] rounded-xl"
        >
          <input
            type="text"
            id="city-input"
            placeholder="Nh·∫≠p t√™n th√†nh ph·ªë..."
            class="w-full pl-3 md:pl-5 pr-12 py-2 sm:py-3 bg-transparent outline-none overflow-hidden text-base"
          />
          <button
            id="get-sunset-btn"
            class="absolute right-0 top-0 h-full flex items-center justify-center px-4 text-gray-400 hover:text-orange-900 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-5 h-5 sm:w-6 sm:h-6"
            >
              <path
                fill-rule="evenodd"
                d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
      </div>

      <div id="results-container">
        <div id="location" class="text-sm text-gray-600 font-medium mb-4"></div>

        <div id="quality-container">
          <div
            id="quality-rating"
            class="text-2xl sm:text-3xl font-extrabold mt-2"
          ></div>
          <div
            id="quality-description"
            class="sm:text-md text-gray-800 mt-1"
          ></div>
        </div>
      </div>
      <div
        id="countdown-container"
        class="hidden inline-flex flex-wrap items-center justify-center"
      >
        <div id="countdown" class="text-sm"></div>
      </div>

      <div id="error" class="text-red-700 font-medium mt-4 min-h-[1.2em]"></div>
      <div id="formula-breakdown" class="text-left hidden"></div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- 1. DOM Element Selection ---
        const cityInput = document.getElementById("city-input");
        const getSunsetBtn = document.getElementById("get-sunset-btn");
        const countdownContainer = document.getElementById(
          "countdown-container"
        );
        const countdownDisplay = document.getElementById("countdown");
        const locationDisplay = document.getElementById("location");
        const errorDisplay = document.getElementById("error");
        const qualityContainer = document.getElementById("quality-container");
        const qualityRatingDisplay = document.getElementById("quality-rating");
        const qualityDescriptionDisplay = document.getElementById(
          "quality-description"
        );
        const formulaBreakdown = document.getElementById("formula-breakdown");

        // --- 2. Global Variable ---
        let subscribeMessageElement;
        let countdownInterval;

        // --- 3. API Endpoints ---
        const GEOCodingApi = "https://geocoding-api.open-meteo.com/v1/search";
        const WeatherApi = "https://api.open-meteo.com/v1/forecast";
        const AirQualityApi =
          "https://air-quality-api.open-meteo.com/v1/air-quality";

        // --- 4. Event Listeners ---
        getSunsetBtn.addEventListener("click", findSunset);
        cityInput.addEventListener("keyup", (event) => {
          if (event.key === "Enter") findSunset();
        });

        const mainContainer = document.getElementById("main-container");

        mainContainer.addEventListener("click", (event) => {
          // Check if the clicked element or its parent is the subscribe button
          const subscribeButton = event.target.closest("#subscribe-btn");

          if (subscribeButton) {
            event.preventDefault();
            subscribeMessageElement =
              document.getElementById("subscribe-message");
            subscribeUserToPush();
          }
        });

        // --- 5. PWA & Push Notification Functions ---
        async function registerServiceWorker() {
          if ("serviceWorker" in navigator && "PushManager" in window) {
            try {
              await navigator.serviceWorker.register("/service-worker.js");
              console.log("Service Worker registered successfully.");
            } catch (error) {
              console.error("Service Worker registration failed:", error);
            }
          }
        }

        async function subscribeUserToPush() {
          if (!subscribeMessageElement) return;
          const city = cityInput.value.trim();
          if (!city) {
            subscribeMessageElement.textContent =
              "B·∫°n ch∆∞a ƒëi·ªÅn t√™n th√†nh ph·ªë.";
            subscribeMessageElement.style.color = "red";
            return;
          }

          subscribeMessageElement.textContent = "ƒêang xin quy·ªÅn th√¥ng b√°o...";
          subscribeMessageElement.style.color = "gray";

          try {
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
              subscribeMessageElement.textContent =
                "B·∫°n ƒë√£ kh√¥ng c·∫•p quy·ªÅn nh·∫≠n th√¥ng b√°o.";
              subscribeMessageElement.style.color = "orange";
              return;
            }

            const swRegistration = await navigator.serviceWorker.ready;
            const vapidPublicKey =
              "BJUIBmQ5BCljrwN3xHY2X8yhawY5KV74i9Br9utNnISg29DEo_m9LRP2_bFUWGuGLfzSBAuc0SXooQamB0amrH8";
            subscribeMessageElement.textContent = "ƒêang ƒëƒÉng k√Ω v·ªõi m√°y ch·ªß...";

            const subscription = await swRegistration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(vapidPublicKey),
            });
            const response = await fetch("/api/save-subscription", {
              method: "POST",
              body: JSON.stringify({ subscription, city }),
              headers: { "Content-Type": "application/json" },
            });

            // alert(`ƒêƒÉng k√Ω nh·∫≠n th√¥ng b√°o cho ${city} th√†nh c√¥ng!`);
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            subscribeMessageElement.textContent = result.message;
            subscribeMessageElement.style.color = "green";
          } catch (error) {
            console.error("Failed to subscribe the user: ", error);
            alert("ƒêƒÉng k√Ω nh·∫≠n th√¥ng b√°o th·∫•t b·∫°i.");
            subscribeMessageElement.textContent = `ƒêƒÉng k√Ω th·∫•t b·∫°i`;
            subscribeMessageElement.style.color = "red";
          }
        }

        function urlBase64ToUint8Array(base64String) {
          const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
          const base64 = (base64String + padding)
            .replace(/-/g, "+")
            .replace(/_/g, "/");
          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }

        // --- 6. Main Application Logic ---
        async function findSunset() {
          const city = cityInput.value.trim();
          if (!city) {
            errorDisplay.textContent = "Vui l√≤ng nh·∫≠p t√™n th√†nh ph·ªë.";
            return;
          }
          cityInput.blur();
          getSunsetBtn.disabled = true;
          resetUI();
          locationDisplay.textContent = "ƒêang l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt...";
          try {
            const geoData = await getGeoCoordinates(city);
            locationDisplay.textContent = `Kh·∫£ nƒÉng c√≥ ho√†ng h√¥n ƒë·∫πp t·∫°i ${geoData.name}, ${geoData.country} h√¥m nay`;

            const [weatherData, airQualityData] = await Promise.all([
              getWeatherData(geoData.latitude, geoData.longitude),
              getAirQualityData(geoData.latitude, geoData.longitude),
            ]);

            // L·∫•y th√¥ng tin ch√™nh l·ªách m√∫i gi·ªù (t√≠nh b·∫±ng gi√¢y) t·ª´ API
            const offsetSeconds = weatherData.utc_offset_seconds;
            // T·∫°o chu·ªói m√∫i gi·ªù ƒë√∫ng chu·∫©n (v√≠ d·ª•: +07:00 ho·∫∑c +03:00)
            const offsetHours = Math.floor(offsetSeconds / 3600);
            const offsetSign = offsetHours >= 0 ? "+" : "-";
            const offsetString = `${offsetSign}${Math.abs(offsetHours)
              .toString()
              .padStart(2, "0")}:00`;

            // Gh√©p chu·ªói th·ªùi gian ho√†ng h√¥n v·ªõi chu·ªói m√∫i gi·ªù ƒë·ªÉ t·∫°o ra m·ªôt th·ªùi ƒëi·ªÉm ch√≠nh x√°c
            const todaySunsetString = `${weatherData.daily.sunset[0]}${offsetString}`;
            const tomorrowSunsetString = `${weatherData.daily.sunset[1]}${offsetString}`;

            const now = new Date();
            const todaySunset = new Date(todaySunsetString);
            const tomorrowSunset = new Date(tomorrowSunsetString);

            const sunsetTime = now > todaySunset ? tomorrowSunset : todaySunset;

            const weatherSunsetHourIndex = findSunsetHourIndex(
              sunsetTime,
              weatherData.hourly.time
            );
            const airSunsetHourIndex = findSunsetHourIndex(
              sunsetTime,
              airQualityData.hourly.time
            );

            startCountdown(sunsetTime);
            displaySunsetQuality(
              weatherData.hourly.cloud_cover[weatherSunsetHourIndex],
              weatherData.hourly.relative_humidity_2m[weatherSunsetHourIndex],
              weatherData.hourly.visibility[weatherSunsetHourIndex],
              weatherData.hourly.pressure_msl[weatherSunsetHourIndex],
              airQualityData.hourly.pm2_5[airSunsetHourIndex]
            );
          } catch (error) {
            console.error("Error:", error);
            errorDisplay.textContent = error.message;
            locationDisplay.textContent = "";
          } finally {
            getSunsetBtn.disabled = false;
          }
        }

        // --- 7. Helper Functions ---
        function findSunsetHourIndex(sunsetTime, hourlyTimes) {
          const sunsetTimestamp = sunsetTime.getTime();
          for (let i = 0; i < hourlyTimes.length; i++) {
            const hourlyTimestamp = new Date(hourlyTimes[i]).getTime();
            if (hourlyTimestamp >= sunsetTimestamp) {
              if (i > 0) {
                const prevHourlyTimestamp = new Date(
                  hourlyTimes[i - 1]
                ).getTime();
                return Math.abs(sunsetTimestamp - prevHourlyTimestamp) <
                  Math.abs(sunsetTimestamp - hourlyTimestamp)
                  ? i - 1
                  : i;
              }
              return i;
            }
          }
          return hourlyTimes.length - 1;
        }

        async function getGeoCoordinates(city) {
          const response = await fetch(
            `${GEOCodingApi}?name=${encodeURIComponent(city)}&count=1`
          );
          if (!response.ok) throw new Error(`L·ªói m√°y ch·ªß: ${response.status}`);
          const data = await response.json();
          if (!data.results || data.results.length === 0)
            throw new Error(`Kh√¥ng t√¨m th·∫•y "${city}". Vui l√≤ng ki·ªÉm tra l·∫°i.`);
          return data.results[0];
        }

        async function getWeatherData(lat, lon) {
          const apiUrl = `${WeatherApi}?latitude=${lat}&longitude=${lon}&daily=sunset&hourly=cloud_cover,relative_humidity_2m,visibility,pressure_msl&timezone=auto&forecast_days=2`;
          const response = await fetch(apiUrl);
          if (!response.ok)
            throw new Error(`L·ªói l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt: ${response.status}`);
          return response.json();
        }

        async function getAirQualityData(lat, lon) {
          const apiUrl = `${AirQualityApi}?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto&forecast_days=2`;
          const response = await fetch(apiUrl);
          if (!response.ok)
            throw new Error(
              `L·ªói l·∫•y d·ªØ li·ªáu ch·∫•t l∆∞·ª£ng kh√¥ng kh√≠: ${response.status}`
            );
          return response.json();
        }

        function calculateScore(value, targetStart, targetEnd) {
          const maxScore = 20;
          if (value >= targetStart && value <= targetEnd) {
            return maxScore;
          }
          const distance =
            value < targetStart ? targetStart - value : value - targetEnd;
          const score = maxScore - (distance * maxScore) / 100;
          return Math.max(0, score);
        }

        function getScoreColor(score) {
          if (score >= 18) return "text-green-700";
          if (score >= 12) return "text-[#8a6e00]";
          return "text-red-600";
        }

        function getFinalScoreColor(finalScore) {
          if (finalScore >= 95) return "text-green-700";
          if (finalScore >= 85) return "text-emerald-600";
          if (finalScore >= 70) return "text-teal-500";
          return "text-gray-500";
        }

        function displaySunsetQuality(
          clouds,
          humidity,
          vis_m,
          pressure,
          pm2_5
        ) {
          const cloudScore = calculateScore(clouds, 30, 70);
          const aerosolScore = calculateScore(pm2_5, 25, 50);
          const vis_km = vis_m / 1000;
          const visibilityScore = Math.min(20, (vis_km / 20) * 20);
          const humidityScore = calculateScore(humidity, 0, 40);
          const pressureScore = calculateScore(pressure, 1020, 1040);

          const finalScore =
            cloudScore +
            aerosolScore +
            visibilityScore +
            humidityScore +
            pressureScore;

          let description;
          if (finalScore >= 95)
            description = "Ho√†n h·∫£o! Ch·∫Øc ch·∫Øn b·∫°n kh√¥ng th·ªÉ b·ªè l·ª°.";
          else if (finalScore >= 85)
            description = "R·∫•t cao! C√≥ th·ªÉ c√≥ nhi·ªÅu d·∫£i n·∫Øng ƒë·∫πp.";
          else if (finalScore >= 70)
            description = "Cao. C√≥ th·ªÉ c√≥ v√†i d·∫£i n·∫Øng d·ªãu.";
          else description = "Kh√¥ng cao. Kh√≥ c√≥ ho√†ng h√¥n ƒë·∫πp.";

          qualityContainer.style.display = "block";
          qualityRatingDisplay.textContent = `${finalScore.toFixed(1)}/100`;
          qualityRatingDisplay.className = `text-3xl font-extrabold mt-2 ${getFinalScoreColor(
            finalScore
          )}`;
          qualityDescriptionDisplay.textContent = description;

          formulaBreakdown.style.display = "block";
          formulaBreakdown.innerHTML = `
        <div class="grid grid-cols-2 sm:gap-4 gap-2 mt-6">
            <div class="factor-card flex flex-col justify-between">
                <div>
                    <div class="flex items-center gap-2"><span class="score-indicator"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg></span><h4 class="text-xs sm:text-sm sm:text-base font-semibold">ƒê·ªô che ph·ªß m√¢y</h4></div>
                    <p class="text-lg my-2 font-bold text-gray-700">${clouds}%</p>
                    <p class="text-xs sm:text-sm text-gray-500 italic">L√Ω t∆∞·ªüng: 40-60%</p>
                </div>
                <p class="mt-2 text-sm font-bold ${getScoreColor(
                  cloudScore
                )}">${cloudScore.toFixed(1)}</p>
            </div>
            <div class="factor-card flex flex-col justify-between">
                <div>
                    <div class="flex items-center gap-2"><span class="score-indicator"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg></span><h4 class="text-xs sm:text-sm sm:text-base font-semibold">N·ªìng ƒë·ªô PM2.5</h4></div>
                    <p class="text-lg my-2 font-bold text-gray-700">${pm2_5.toFixed(
                      1
                    )} ¬µg/m¬≥</p>
                    <p class="text-xs sm:text-sm text-gray-500 italic">L√Ω t∆∞·ªüng: 12-35 ¬µg/m¬≥</p>
                </div>
                <p class="mt-2 text-sm font-bold ${getScoreColor(
                  aerosolScore
                )}">${aerosolScore.toFixed(1)}</p>
            </div>
            <div class="factor-card flex flex-col justify-between">
                <div>
                    <div class="flex items-center gap-2"><span class="score-indicator"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></span><h4 class="text-xs sm:text-sm sm:text-base font-semibold">T·∫ßm nh√¨n</h4></div>
                    <p class="text-lg my-2 font-bold text-gray-700">${vis_km.toFixed(
                      1
                    )} km</p>
                    <p class="text-xs sm:text-sm text-gray-500 italic">L√Ω t∆∞·ªüng: >20 km</p>
                </div>
                <p class="mt-2 text-sm font-bold ${getScoreColor(
                  visibilityScore
                )}">${visibilityScore.toFixed(1)}</p>
            </div>
            <div class="factor-card flex flex-col justify-between">
                <div>
                    <div class="flex items-center gap-2"><span class="score-indicator"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg></span><h4 class="text-xs sm:text-sm sm:text-base font-semibold">ƒê·ªô ·∫©m</h4></div>
                    <p class="text-lg my-2 font-bold text-gray-700">${humidity}%</p>
                    <p class="text-xs sm:text-sm text-gray-500 italic">L√Ω t∆∞·ªüng: <40%</p>
                </div>
                <p class="mt-2 text-sm font-bold ${getScoreColor(
                  humidityScore
                )}">${humidityScore.toFixed(1)}</p>
            </div>
            <div class="factor-card flex flex-col justify-between col-span-2">
                <div>
                    <div class="flex items-center gap-2">
                      <span class="score-indicator">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="12" cy="12" r="9"/><line x1="12" y1="12" x2="16" y2="8"/>
                          <circle cx="12" cy="12" r="1"/>
                        </svg>
                      </span>
                      <h4 class="text-xs sm:text-sm sm:text-base font-semibold">√Åp su·∫•t</h4>
                    </div>
                    <p class="text-lg my-2 font-bold text-gray-700">${pressure.toFixed(
                      0
                    )} hPa</p>
                    <p class="text-xs sm:text-sm text-gray-500 italic">L√Ω t∆∞·ªüng: >1020 hPa</p>
                </div>
                <p class="mt-2 text-sm font-bold ${getScoreColor(
                  pressureScore
                )}">${pressureScore.toFixed(1)}</p>
            </div>

        </div>
        <div class="mt-8 text-gray-700">
          <h3 class="text-sm sm:text-base font-bold text-gray-800 mb-2">C√°ch nh·∫≠n th√¥ng b√°o</h3>
          <ul class="text-xs sm:text-sm mt-3 space-y-2">
            <li>Th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c g·ª≠i khi <strong class="text-orange-900">t·ªïng ƒëi·ªÉm h√¥m ƒë√≥ >=80 v√† trong v√≤ng 15 ph√∫t tr∆∞·ªõc ho√†ng h√¥n</strong></li>
            <li><strong>iPhone:</strong> <i>M·ªü web tr√™n Safari > Chia s·∫ª > Th√™m v√†o MH ch√≠nh > M·ªü app > T√¨m th√†nh ph·ªë > "Subscribe" > "Cho ph√©p" > Ch·ªù popup x√°c nh·∫≠n.</i></li>
            <li><strong>Android:</strong> <i>M·ªü web tr√™n Chrome > Menu > "C√†i ƒë·∫∑t ·ª©ng d·ª•ng" > M·ªü app > T√¨m th√†nh ph·ªë > "Subscribe" > "Cho ph√©p" > Ch·ªù popup x√°c nh·∫≠n.</i></li>
            <li><strong class="text-red-700">L∆∞u √Ω:</strong> Low Power Mode hay Focus Mode c√≥ th·ªÉ ch·∫∑n ho·∫∑c l√†m tr·ªÖ th√¥ng b√°o.</li>
           </ul>

          <h3 class="text-sm sm:text-base font-bold text-gray-800 mt-8 sm:mt-10">C√°ch t√≠nh ƒëi·ªÉm</h3>
          <ul class="text-xs sm:text-sm mt-3 space-y-2">
              <li>T·ªïng ƒëi·ªÉm: 100, d·ª±a tr√™n 5 y·∫øu t·ªë th·ªùi ti·∫øt.</li>
              <li>M√†u t·ªïng ƒëi·ªÉm t·ª´ cao-th·∫•p: 
                <i>
                  <span class="text-green-700">l√° ƒë·∫≠m</span> (>= 95), 
                  <span class="text-emerald-600 ">l√°</span> (>=85), 
                  <span class="text-teal-500">xanh</span> (>=70), 
                  <span class="text-gray-500">x√°m</span> (<70).
                </i>
              </li>
              <li>M·ªói y·∫øu t·ªë c√≥ ƒëi·ªÉm t·ªëi ƒëa 20 n·∫øu trong ph·∫°m vi l√Ω t∆∞·ªüng (PVLT), l·ªách c√†ng nhi·ªÅu ƒëi·ªÉm c√†ng gi·∫£m.</li>
              <li>M√†u ƒëi·ªÉm y·∫øu t·ªë t·ª´ cao-th·∫•p: 
                <i>
                  <span class="text-green-700">l√°</span> (18-20), 
                  <span class="text-[#8a6e00]">v√†ng</span> (<18), 
                  <span class="text-red-600">ƒë·ªè</span> (<12)
                </i>
              </li>
              <li>ƒêi·ªÉm y·∫øu t·ªë = <strong>20 - (Ch√™nh l·ªách v·ªõi PVLT x 0.2)</strong> <br/>v·ªõi 0.2 l√† ƒë·ªÉ chuy·ªÉn ƒë·ªïi thang ƒëi·ªÉm 20 tr√™n t·ªïng 100</li>
              <li class="italic">V√≠ d·ª•: ƒê·ªô che ph·ªß m√¢y h√¥m nay 93% - PVLT 60% = 33% <br/>=> ƒêi·ªÉm y·∫øu t·ªë = 20 - (33 x 0.2) = <strong>13.4</strong></li>
          </ul>          
        </div>
      `;

          errorDisplay.className = "mt-4";
          errorDisplay.innerHTML = `
           <button 
            id="subscribe-btn" 
            class="flex items-center justify-between gap-2 py-2 px-4 bg-transparent border border-[#d9c8b8] rounded-full"
          >
            <span class="text-sm font-medium">Subscribe</span>
            <svg 
              xmlns="http://www.w3.org/2000/svg" 
              class="w-5 h-5" 
              fill="none" 
              viewBox="0 0 24 24" 
              stroke="currentColor" 
              stroke-width="1.25"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
          </button>
            <p id="subscribe-message" class="text-sm mt-2 min-h-[1.2em] text-left"></p>
          `;

          document
            .getElementById("subscribe-btn")
            .addEventListener("click", subscribeUserToPush);
        }

        function startCountdown(targetDate) {
          countdownContainer.style.display = "block";
          if (countdownInterval) clearInterval(countdownInterval);
          const update = () => {
            const now = new Date().getTime();
            const distance = targetDate - now;
            if (distance < 0) {
              clearInterval(countdownInterval);
              countdownDisplay.textContent = "Ho√†ng h√¥n ƒë√£ qua r·ªìi nha.";
              return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor(
              (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
            );
            const minutes = Math.floor(
              (distance % (1000 * 60 * 60)) / (1000 * 60)
            );
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            let str = `<span class="font-bold text-orange-900">${hours}h ${minutes}m ${seconds}s</span> n·ªØa l√† ho√†ng h√¥n`;
            if (days > 0) str = `${days}d ` + str;
            countdownDisplay.innerHTML = str;
          };
          update();
          countdownInterval = setInterval(update, 1000);
        }

        function resetUI() {
          errorDisplay.innerHTML = "";
          errorDisplay.className = "text-sm md:text-md mt-4 min-h-[1.2em]";
          locationDisplay.textContent = "";
          countdownContainer.style.display = "none";
          qualityContainer.style.display = "none";
          formulaBreakdown.style.display = "none";
          if (countdownInterval) clearInterval(countdownInterval);
        }

        // Initial call to register the service worker when the page is ready.
        registerServiceWorker();
      });
    </script>
  </body>
</html>
