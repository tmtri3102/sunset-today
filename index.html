<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A small gift by Tri. Happy Birthday</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåÖ</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      #main-container {
        caret-color: transparent;
      }
      #city-input {
        caret-color: initial;
      }
      body {
        font-family: "Merriweather", sans-serif;
      }
      .factor-card {
        padding: 1rem;
        border-radius: 0.5rem;
        /* border: solid 0.3px lightslategray; */
        background-color: #fafafa;
      }
    </style>
  </head>
  <body
    class="flex items-start min-h-screen p-4 md:p-10 md:justify-center"
    contenteditable="false"
  >
    <div
      id="main-container"
      class="w-full max-w-lg mx-auto text-left rounded-2xl p-4 md:p-8 flex flex-col"
    >
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">
        Ho√†ng h√¥n h√¥m nay th·∫ø n√†o?
      </h1>
      <div class="flex items-center justify-center mb-2">
        <div
          class="relative w-full border-2 border-gray-300 rounded-xl transition-colors"
        >
          <input
            type="text"
            id="city-input"
            placeholder="Nh·∫≠p t√™n th√†nh ph·ªë..."
            class="w-full pl-4 pr-12 py-3 bg-transparent outline-none overflow-hidden"
          />
          <button
            id="get-sunset-btn"
            class="absolute right-0 top-0 h-full flex items-center justify-center px-4 text-gray-400 hover:text-blue-500 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="w-6 h-6"
            >
              <path
                fill-rule="evenodd"
                d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
      </div>

      <div id="results-container">
        <div id="location" class="text-sm text-gray-600 font-medium mb-4"></div>

        <div id="quality-container">
          <div
            id="quality-rating"
            class="text-2xl sm:text-3xl font-extrabold mt-2"
          ></div>
          <div
            id="quality-description"
            class="sm:text-md text-gray-800 mt-1"
          ></div>
        </div>
      </div>
      <div
        id="countdown-container"
        class="hidden inline-flex flex-wrap items-center justify-center"
      >
        <div id="countdown" class="text-sm"></div>
      </div>

      <div id="error" class="text-red-500 font-medium mt-4 min-h-[1.2em]"></div>
      <div id="formula-breakdown" class="text-left hidden"></div>
    </div>
    <script>
      // API Keys and URLs
      // Note: These APIs are free and do not require a key.
      const GEOCodingApi = "https://geocoding-api.open-meteo.com/v1/search";
      const WeatherApi = "https://api.open-meteo.com/v1/forecast";

      // DOM Elements
      const cityInput = document.getElementById("city-input");
      const getSunsetBtn = document.getElementById("get-sunset-btn");
      const countdownDisplay = document.getElementById("countdown");
      const locationDisplay = document.getElementById("location");
      const errorDisplay = document.getElementById("error");
      const countdownContainer = document.getElementById("countdown-container");
      const qualityContainer = document.getElementById("quality-container");
      const qualityRatingDisplay = document.getElementById("quality-rating");
      const qualityDescriptionDisplay = document.getElementById(
        "quality-description"
      );
      const formulaBreakdown = document.getElementById("formula-breakdown");
      const scoreDot = document.getElementById("score-dot");

      let countdownInterval;

      getSunsetBtn.addEventListener("click", findSunset);
      cityInput.addEventListener("keyup", (event) => {
        if (event.key === "Enter") findSunset();
      });

      /**
       * Main function to orchestrate fetching and displaying sunset data.
       */
      async function findSunset() {
        const city = cityInput.value.trim();
        if (!city) {
          errorDisplay.textContent = "Vui l√≤ng nh·∫≠p t√™n th√†nh ph·ªë.";
          return;
        }

        cityInput.blur();
        getSunsetBtn.disabled = true;

        resetUI();
        locationDisplay.textContent = "ƒêang l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt...";

        try {
          const geoData = await getGeoCoordinates(city);
          const { latitude, longitude, name, country } = geoData;
          locationDisplay.textContent = `Kh·∫£ nƒÉng c√≥ ho√†ng h√¥n ƒë·∫πp t·∫°i ${name}, ${country} h√¥m nay`;

          const weatherData = await getWeatherData(latitude, longitude);

          const now = new Date();
          let sunsetTime, sunsetHourIndex;
          const todaySunset = new Date(weatherData.daily.sunset[0]);
          const tomorrowSunset = new Date(weatherData.daily.sunset[1]);

          if (now > todaySunset) {
            sunsetTime = tomorrowSunset;
            const tomorrowTimestamp = sunsetTime.getTime();
            sunsetHourIndex = weatherData.hourly.time.findIndex(
              (time) => new Date(time).getTime() === tomorrowTimestamp
            );
          } else {
            sunsetTime = todaySunset;
            const todayTimestamp = sunsetTime.getTime();
            sunsetHourIndex = weatherData.hourly.time.findIndex(
              (time) => new Date(time).getTime() === todayTimestamp
            );
          }

          if (sunsetHourIndex === -1) {
            const nowHour = Math.floor(now.getTime() / 3600000) * 3600000;
            const nearestHour = weatherData.hourly.time.find(
              (time) => new Date(time).getTime() >= nowHour
            );
            sunsetHourIndex = weatherData.hourly.time.indexOf(nearestHour);
          }

          startCountdown(sunsetTime);

          const cloudCover = weatherData.hourly.cloud_cover[sunsetHourIndex];
          const humidity =
            weatherData.hourly.relative_humidity_2m[sunsetHourIndex];
          const visibility = weatherData.hourly.visibility[sunsetHourIndex]; // in meters
          const windSpeed = weatherData.hourly.wind_speed_10m[sunsetHourIndex]; // in km/h
          const precipProb =
            weatherData.hourly.precipitation_probability[sunsetHourIndex];

          displaySunsetQuality(
            cloudCover,
            humidity,
            visibility,
            windSpeed,
            precipProb
          );
        } catch (error) {
          console.error("Error:", error);
          errorDisplay.textContent = error.message;
          locationDisplay.textContent = "";
        } finally {
          getSunsetBtn.disabled = false;
        }
      }

      /**
       * Fetches geographic coordinates for a given city.
       */
      async function getGeoCoordinates(city) {
        const response = await fetch(
          `${GEOCodingApi}?name=${encodeURIComponent(city)}&count=1`
        );
        if (!response.ok) {
          throw new Error(
            `Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu v·ªã tr√≠. M√°y ch·ªß ph·∫£n h·ªìi v·ªõi tr·∫°ng th√°i: ${response.status}`
          );
        }
        const data = await response.json();
        if (!data.results || data.results.length === 0) {
          throw new Error(
            `Kh√¥ng t√¨m th·∫•y "${city}". Vui l√≤ng ki·ªÉm tra ch√≠nh t·∫£.`
          );
        }
        return data.results[0];
      }

      /**
       * Fetches all necessary hourly weather data.
       */
      async function getWeatherData(lat, lon) {
        const apiUrl = `${WeatherApi}?latitude=${lat}&longitude=${lon}&daily=sunset&hourly=cloud_cover,relative_humidity_2m,visibility,wind_speed_10m,precipitation_probability&timezone=auto&forecast_days=2`;
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(
            `Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt. M√°y ch·ªß ph·∫£n h·ªìi v·ªõi tr·∫°ng th√°i: ${response.status}`
          );
        }
        return response.json();
      }

      /**
       * Calculates the score for a single factor based on a target range,
       * with a maximum possible score of 20 points.
       * @param {number} value The current value of the factor.
       * @param {number} targetStart The start of the optimal range.
       * @param {number} targetEnd The end of the optimal range.
       * @returns {number} The calculated score (0-20).
       */
      function calculateScore(value, targetStart, targetEnd) {
        const maxScore = 20;
        if (value >= targetStart && value <= targetEnd) {
          return maxScore;
        }
        const distance =
          value < targetStart ? targetStart - value : value - targetEnd;
        const score = maxScore - (distance * maxScore) / 100;
        return Math.max(0, score);
      }

      /**
       * Determines the color class for a given score.
       * @param {number} score The score for a single factor.
       * @returns {string} A string containing a color class (e.g., 'text-green-500').
       */
      function getScoreColor(score) {
        if (score >= 18) return "text-green-500";
        if (score >= 12) return "text-yellow-500";
        return "text-red-500";
      }

      /**
       * Gets the color class for the final rating based on the total score.
       * @param {number} finalScore The total score out of 100.
       * @returns {string} The Tailwind color class.
       */
      function getFinalScoreColor(finalScore) {
        if (finalScore >= 95) return "text-emerald-600";
        if (finalScore >= 85) return "text-green-500";
        if (finalScore >= 70) return "text-blue-500";
        return "text-gray-500";
      }

      /**
       * Gets the background color class for the score dot.
       * @param {number} finalScore The total score out of 100.
       * @returns {string} The Tailwind background color class.
       */
      function getDotColor(finalScore) {
        if (finalScore >= 95) return "bg-emerald-600";
        if (finalScore >= 85) return "bg-green-400";
        if (finalScore >= 70) return "bg-blue-500";
        return "bg-gray-300";
      }

      /**
       * Calculates and displays the sunset quality score and breakdown.
       */
      function displaySunsetQuality(
        clouds,
        humidity,
        vis_m,
        wind_kph,
        precipProb
      ) {
        // Factor 1: Cloud Cover (Ideal: 40-60%)
        const cloudScore = calculateScore(clouds, 40, 60);

        // Factor 2: Humidity (Ideal: 0-40%)
        const humidityScore = calculateScore(humidity, 0, 40);

        // Factor 3: Visibility (Ideal: > 20 km)
        const vis_km = vis_m / 1000;
        const visibilityScore = Math.min(20, (vis_km / 20) * 20);

        // Factor 4: Wind Speed (Ideal: 0-10 km/h)
        const windScore = calculateScore(wind_kph, 0, 10);

        // Factor 5: Precipitation Probability (Ideal: 0-5%)
        const precipScore = calculateScore(precipProb, 0, 5);

        const finalScore = Math.max(
          0,
          Math.min(
            100,
            Math.round(
              cloudScore +
                humidityScore +
                visibilityScore +
                windScore +
                precipScore
            )
          )
        );

        // Get description based on score
        let rating, description;
        if (finalScore >= 95) {
          rating = `${finalScore}/100`;
          description = "Ho√†n h·∫£o! Ch·∫Øc ch·∫Øn b·∫°n kh√¥ng th·ªÉ b·ªè l·ª°.";
        } else if (finalScore >= 85) {
          rating = `${finalScore}/100`;
          description = "R·∫•t cao! C√≥ th·ªÉ c√≥ nhi·ªÅu d·∫£i n·∫Øng ƒë·∫πp.";
        } else if (finalScore >= 70) {
          rating = `${finalScore}/100`;
          description = "Cao. C√≥ th·ªÉ c√≥ v√†i d·∫£i n·∫Øng d·ªãu.";
        } else {
          rating = `${finalScore}/100`;
          description = "Kh√¥ng cao. Kh√≥ c√≥ ho√†ng h√¥n ƒë·∫πp.";
        }

        // Update UI
        qualityContainer.style.display = "block";
        qualityContainer.className = "mb-2";
        qualityRatingDisplay.textContent = rating;
        qualityRatingDisplay.className = `text-3xl font-extrabold mt-2 ${getFinalScoreColor(
          finalScore
        )}`;
        qualityDescriptionDisplay.textContent = description;

        // Generate the new, simplified breakdown HTML
        formulaBreakdown.style.display = "block";
        formulaBreakdown.innerHTML = `
                <div class="grid grid-cols-2 sm:gap-4 gap-2 ">
                    <!-- Clouds -->
                    <div class="factor-card">
                        <div class="flex items-center gap-2">
<span class="score-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg></span>
                            <h4 class="text-sm sm:text-base font-semibold">ƒê·ªô che ph·ªß m√¢y</h4>
                        </div>
                        <p class="text-base sm:text-xxl my-2 font-bold text-gray-700">${clouds}%</p>
                        <p class="text-sm text-gray-500 italic">L√Ω t∆∞·ªüng = 40-60%</p>
                        <p class="mt-2 sm:text-sm  font-bold ${getScoreColor(
                          cloudScore
                        )}">${cloudScore.toFixed(1)}</p>
                    </div>

                    <!-- Humidity -->
                    <div class="factor-card">
                        <div class="flex items-center gap-2">
<span class="score-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg></span>
                            <h4 class="text-sm sm:text-base font-semibold">ƒê·ªô ·∫©m</h4>
                        </div>
                        <p class="text-base sm:text-xxl my-2 font-bold text-gray-700">${humidity}%</p>
                        <p class="text-sm text-gray-500 italic">L√Ω t∆∞·ªüng = <40%</p>
                        <p class="mt-2 sm:text-sm  font-bold ${getScoreColor(
                          humidityScore
                        )}">${humidityScore.toFixed(1)}</p>
                    </div>
                    
                    <!-- Visibility -->
                    <div class="factor-card">
                        <div class="flex items-center gap-2">
<span class="score-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></span>
                            <h4 class="text-sm sm:text-base font-semibold">T·∫ßm nh√¨n</h4>
                        </div>
                        <p class="text-base sm:text-xxl my-2 font-bold text-gray-700">${vis_km.toFixed(
                          1
                        )} km</p>
                        <p class="text-sm text-gray-500 italic">L√Ω t∆∞·ªüng = >20 km</p>
                        <p class="mt-2 sm:text-sm  font-bold ${getScoreColor(
                          visibilityScore
                        )}">${visibilityScore.toFixed(1)}</p>
                    </div>

                    <!-- Wind Speed -->
                    <div class="factor-card">
                        <div class="flex items-center gap-2">
<span class="score-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"></path></svg></span>
                            <h4 class="text-sm sm:text-base font-semibold">T·ªëc ƒë·ªô gi√≥</h4>
                        </div>
                        <p class="text-base sm:text-xxl my-2 font-bold text-gray-700">${wind_kph.toFixed(
                          1
                        )} km/h</p>
                        <p class="text-sm text-gray-500 italic">L√Ω t∆∞·ªüng = <10 km/h</p>
                        <p class="mt-2 sm:text-sm  font-bold ${getScoreColor(
                          windScore
                        )}">${windScore.toFixed(1)}</p>
                    </div>

                    <!-- Precipitation -->
                    <div class="factor-card">
                        <div class="flex items-center gap-2">
<span class="score-indicator"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg></span>
                            <h4 class="text-sm sm:text-base font-semibold">X√°c su·∫•t m∆∞a</h4>
                        </div>
                        <p class="text-base sm:text-xxl my-2 font-bold text-gray-700">${precipProb}%</p>
                        <p class="text-sm text-gray-500 italic">L√Ω t∆∞·ªüng = <5%</p>
                        <p class="mt-2 sm:text-sm  font-bold ${getScoreColor(
                          precipScore
                        )}">${precipScore.toFixed(1)}</p>
                    </div>
                </div>
                <div class="mt-8 text-gray-700">
                    <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2">C√°ch t√≠nh ƒëi·ªÉm</h3>
                    <ul class="text-xs sm:text-sm mt-4 space-y-2">
                        <li>T·ªïng 100 ƒëi·ªÉm d·ª±a tr√™n 5 y·∫øu t·ªë th·ªùi ti·∫øt.</li>
                        <li>M·ªói y·∫øu t·ªë c√≥ ƒëi·ªÉm t·ªëi ƒëa 20 khi gi√° tr·ªã n·∫±m trong ph·∫°m vi l√Ω t∆∞·ªüng (PVLT). ƒêi·ªÉm n√†y s·∫Ω gi·∫£m n·∫øu gi√° tr·ªã n·∫±m ngo√†i ph·∫°m vi ƒë√≥.</li>
                        <li>ƒêi·ªÉm y·∫øu t·ªë c√≥ m√†u <italic class="text-green-500">xanh l√° n·∫øu gi√° tr·ªã trong PVLT</italic>, <italic class="text-yellow-600">v√†ng n·∫øu g·∫ßn PVLT</italic> v√† <italic class="text-red-500">ƒë·ªè n·∫øu xa PVLT</italic>.</li>
                        <li>T·ªïng ƒëi·ªÉm c√≥ m√†u <italic class="text-emerald-600">l√° ƒë·∫≠m n·∫øu >=95</italic>, <italic class="text-green-500">xanh l√° n·∫øu >=85</italic>, <italic class="text-blue-500">xanh d∆∞∆°ng n·∫øu >=70</italic> v√† <italic class="text-gray-500">x√°m n·∫øu <70</italic>.</li>
                    </ul>
                    <p class="font-semibold mt-4">V√≠ d·ª•: ƒê·ªô che ph·ªß m√¢y = 93% v√† c√≥ ƒëi·ªÉm 13.4</p>
                    <ol class="list-decimal list-inside text-xs sm:text-sm mt-2 space-y-2">
                        <li>T√≠nh ƒë·ªô l·ªách (Deviation): b·∫±ng gi√° tr·ªã 93% ch√™nh l·ªách v·ªõi ƒëi·ªÉm g·∫ßn nh·∫•t c·ªßa PVLT (40-60%): <strong>93% - 60% = 33%</strong></li>
                        <li>T√≠nh ƒëi·ªÉm ph·∫°t (Penalty): b·∫±ng <strong>ƒë·ªô l·ªách x (20 / 100) = 33 x 0.2 = 6.6</strong>. <br/>V·ªÅ b·∫£n ch·∫•t ta ƒëang "map" ƒë·ªô l·ªách (33%) c·ªßa gi√° tr·ªã v·ªõi ƒë·ªô l·ªách c·ªßa thang ƒëi·ªÉm 0-20 (6.6)</li>
                        <li>ƒêi·ªÉm cu·ªëi c√πng: b·∫±ng <strong>20 - ƒëi·ªÉm ph·∫°t = 20 - 6.6 = 13.4 pt </strong></li>
                    </ol>
                </div>
            `;
      }

      /**
       * Starts the countdown timer.
       */
      function startCountdown(targetDate) {
        countdownContainer.style.display = "block";
        if (countdownInterval) clearInterval(countdownInterval);

        countdownInterval = setInterval(() => {
          const now = new Date().getTime();
          const distance = targetDate - now;

          if (distance < 0) {
            clearInterval(countdownInterval);
            countdownDisplay.textContent = "Ho√†ng h√¥n ƒë√£ qua r·ªìi nha.";
            return;
          }

          const days = Math.floor(distance / (1000 * 60 * 60 * 24));
          const hours = Math.floor(
            (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
          );
          const minutes = Math.floor(
            (distance % (1000 * 60 * 60)) / (1000 * 60)
          );
          const seconds = Math.floor((distance % (1000 * 60)) / 1000);

          let str = `c√≤n ${hours}h ${minutes}m ${seconds}s n·ªØa l√† ho√†ng h√¥n`;
          if (days > 0) str = `${days}d ` + str;
          countdownDisplay.textContent = str;
        }, 1000);
      }

      /**
       * Resets UI elements for a new search.
       */
      function resetUI() {
        errorDisplay.textContent = "";
        locationDisplay.textContent = "";
        countdownContainer.style.display = "none";
        qualityContainer.style.display = "none";
        formulaBreakdown.style.display = "none";
        countdownDisplay.textContent = "";
        qualityRatingDisplay.textContent = "";
        qualityDescriptionDisplay.textContent = "";
        formulaBreakdown.innerHTML = "";
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }
      }
    </script>
  </body>
</html>
